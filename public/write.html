<!DOCTYPE html>
<html>
<head>
    <title>Create Page - Doxify</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        *{margin:0;padding:0;box-sizing:border-box;font-family:Arial,sans-serif;}
        body{background:#000;color:#fff;padding:20px;}
        .container{max-width:800px;margin:0 auto;}
        header{border-bottom:1px solid #333;padding:10px 0;margin-bottom:20px;}
        .logo{font-size:24px;font-weight:bold;color:#fff;text-decoration:none;}
        nav a{color:#ccc;text-decoration:none;margin-right:15px;}
        .form-group{margin-bottom:15px;}
        label{display:block;margin-bottom:5px;color:#ccc;}
        input,textarea{width:100%;padding:8px;background:#111;border:1px solid #333;color:#fff;}
        textarea{height:300px;resize:vertical;}
        .btn{padding:8px 15px;background:#333;color:#fff;border:1px solid #333;cursor:pointer;}
        .btn:disabled{background:#222;color:#666;cursor:not-allowed;}
        .error{color:#f00;font-size:12px;margin-top:5px;}
        .success{color:#0f0;font-size:12px;margin-top:5px;}
    </style>
</head>
<body>
    <div class="container">
        <header>
            <a href="/" class="logo">DOXIFY</a>
            <nav>
                <a href="/">Home</a>
                <a href="/write">Write</a>
            </nav>
        </header>

        <h2>Create Page</h2>
        <form id="doxForm">
            <div class="form-group">
                <label>Page URL</label>
                <input type="text" id="slug" placeholder="page-name" required>
                <div id="slugStatus"></div>
            </div>
            <div class="form-group">
                <label>Title</label>
                <input type="text" id="title" required>
            </div>
            <div class="form-group">
                <label>Content</label>
                <textarea id="content" required></textarea>
            </div>
            <button type="submit" class="btn" id="submitBtn" disabled>Create Page</button>
            <div id="formStatus" style="margin-top:15px;"></div>
        </form>
    </div>

    <script>
        const slugInput = document.getElementById('slug');
        const titleInput = document.getElementById('title');
        const contentInput = document.getElementById('content');
        const slugStatus = document.getElementById('slugStatus');
        const formStatus = document.getElementById('formStatus');
        const submitBtn = document.getElementById('submitBtn');
        const form = document.getElementById('doxForm');

        let slugCheckTimeout;
        let isSlugAvailable = false;

        function validateSlug(slug) {
            return /^[a-zA-Z0-9-]{3,50}$/.test(slug);
        }

        async function checkSlug(slug) {
            try {
                const response = await fetch(`/api/check-slug?slug=${encodeURIComponent(slug)}`);
                const result = await response.json();
                return result.available;
            } catch {
                return false;
            }
        }

        function showStatus(element, message, type) {
            element.textContent = message;
            element.className = type;
            element.style.display = 'block';
        }

        function hideStatus(element) {
            element.style.display = 'none';
        }

        async function onSlugInput() {
            const slug = slugInput.value.trim().toLowerCase();
            
            clearTimeout(slugCheckTimeout);
            
            if (slug.length === 0) {
                hideStatus(slugStatus);
                submitBtn.disabled = true;
                return;
            }
            
            if (!validateSlug(slug)) {
                showStatus(slugStatus, 'Use letters, numbers, hyphens (3-50 chars)', 'error');
                submitBtn.disabled = true;
                return;
            }
            
            showStatus(slugStatus, 'Checking...', 'success');
            
            slugCheckTimeout = setTimeout(async () => {
                isSlugAvailable = await checkSlug(slug);
                
                if (isSlugAvailable) {
                    showStatus(slugStatus, 'Available', 'success');
                    updateSubmitButton();
                } else {
                    showStatus(slugStatus, 'Already taken', 'error');
                    submitBtn.disabled = true;
                }
            }, 500);
        }

        function updateSubmitButton() {
            const hasData = titleInput.value.trim() && contentInput.value.trim();
            submitBtn.disabled = !(isSlugAvailable && hasData);
        }

        async function submitForm(e) {
            e.preventDefault();
            
            const data = {
                slug: slugInput.value.trim().toLowerCase(),
                title: titleInput.value.trim(),
                content: contentInput.value.trim()
            };

            submitBtn.disabled = true;
            submitBtn.textContent = 'Creating...';
            hideStatus(formStatus);

            try {
                const response = await fetch('/api/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                
                if (result.success) {
                    showStatus(formStatus, 'Page created! Redirecting...', 'success');
                    setTimeout(() => {
                        window.location.href = `/${result.slug}`;
                    }, 1000);
                } else {
                    showStatus(formStatus, result.error, 'error');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Create Page';
                }
            } catch (error) {
                showStatus(formStatus, 'Network error', 'error');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Create Page';
            }
        }

        slugInput.addEventListener('input', onSlugInput);
        titleInput.addEventListener('input', updateSubmitButton);
        contentInput.addEventListener('input', updateSubmitButton);
        form.addEventListener('submit', submitForm);
    </script>
</body>
</html>
